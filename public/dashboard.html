<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - KeyGuardius</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="KeyGuardius">
    <link rel="manifest" href="/manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Enhanced Styles -->
    <link rel="stylesheet" href="/enhanced-styles.css">
    
    <script src="notifications.js"></script>
    <script src="rewards-system.js"></script>
    <script src="live-feed.js"></script>
    <script src="redeem-system.js"></script>
    <style>
        * { font-family: 'DM Sans', sans-serif; }
        html { background: #0a0a0a; min-height: 100%; }
        body { 
            background: #0a0a0a; 
            color: #fafafa; 
            position: relative;
            min-height: 100vh;
        }
        
        /* Light mode overrides */
        html.light { background: #ffffff !important; }
        .light body { 
            background: #ffffff !important; 
            color: #111827 !important; 
        }
        
        body::before { 
            content: ''; 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"); 
            opacity: 0.03; 
            pointer-events: none;
            z-index: 0;
        }
        .light body::before {
            opacity: 0.02;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px); 
            background-size: 20px 20px;
            pointer-events: none;
            z-index: 0;
        }
        .light body::after {
            background-image: radial-gradient(rgba(0, 0, 0, 0.05) 1px, transparent 1px);
        }
        
        .btn-primary { transition: all 0.2s; }
        .btn-primary:hover { transform: translateY(-1px); }
        .card-hover { transition: all 0.3s; }
        .card-hover:hover { background: rgba(255, 255, 255, 0.04); transform: translateY(-2px); }

        /* Enhanced Progress Bar Styles - Blue Theme */
        .progress-bar-container {
            position: relative;
            height: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 9999px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .progress-bar-fill-blue {
            position: relative;
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 9999px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .progress-bar-fill-purple {
            position: relative;
            height: 100%;
            background: linear-gradient(90deg, #a855f7 0%, #9333ea 100%);
            border-radius: 9999px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        /* Animated diagonal lines pattern - moves right to left */
        .progress-bar-fill-blue::before,
        .progress-bar-fill-purple::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: repeating-linear-gradient(
                45deg,
                transparent 0px,
                transparent 4px,
                rgba(255, 255, 255, 0.25) 4px,
                rgba(255, 255, 255, 0.25) 8px
            );
            background-size: 14px 14px;
            animation: diagonal-move 1s linear infinite;
        }

        @keyframes diagonal-move {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 14px 14px;
            }
        }

        /* Glow effects */
        .progress-bar-fill-blue {
            box-shadow: 
                0 0 10px rgba(59, 130, 246, 0.3),
                0 0 20px rgba(59, 130, 246, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .progress-bar-fill-purple {
            box-shadow: 
                0 0 10px rgba(168, 85, 247, 0.3),
                0 0 20px rgba(168, 85, 247, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="min-h-screen">
    <nav class="relative border-b border-white/[0.08] backdrop-blur-xl bg-black/40 z-10">
        <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
            <a href="/dashboard" class="flex items-center gap-2.5">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-500">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
                <span class="font-semibold text-[15px]">KeyGuardius</span>
            </a>
            <div class="flex items-center gap-6">
                <a href="/scripts" class="text-sm text-zinc-400 hover:text-blue-400 transition-colors">Scripts</a>
                <a href="/executors" class="text-sm text-zinc-400 hover:text-blue-400 transition-colors">Executors</a>
                <a href="#" id="redeem-key-btn" class="text-sm text-zinc-400 hover:text-green-400 transition-colors flex items-center gap-1.5">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/>
                    </svg>
                    Redeem Key
                </a>
                <a href="/dashboard" class="text-sm px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-white font-semibold transition-all">
                    Get Key
                </a>
            </div>
        </div>
    </nav>

    <div class="relative max-w-7xl mx-auto px-6 py-12 z-10">
        <div class="mb-8">
            <h1 class="text-4xl font-bold mb-2">Dashboard</h1>
            <p class="text-zinc-400">Welcome back, <span class="text-blue-400">Tom</span></p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="border border-white/[0.08] rounded-xl p-6 bg-white/[0.02]">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 rounded-lg bg-blue-500/10 flex items-center justify-center">
                        <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-2xl font-bold">2</p>
                        <p class="text-sm text-zinc-500">Methods Available</p>
                    </div>
                </div>
            </div>

            <div class="border border-white/[0.08] rounded-xl p-6 bg-white/[0.02]">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 rounded-lg bg-purple-500/10 flex items-center justify-center">
                        <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-2xl font-bold">24h</p>
                        <p class="text-sm text-zinc-500">Key Duration</p>
                    </div>
                </div>
            </div>

            <div class="border border-white/[0.08] rounded-xl p-6 bg-white/[0.02]">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 rounded-lg bg-green-500/10 flex items-center justify-center">
                        <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-2xl font-bold">100%</p>
                        <p class="text-sm text-zinc-500">Secure & Safe</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Method Selection Section -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold mb-2">Choose Your Method</h2>
            <p class="text-zinc-400 mb-6">Select one of the methods below to obtain your access key</p>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Work.ink Method Card -->
                <div class="border border-white/[0.08] rounded-xl p-6 bg-white/[0.02] card-hover">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="text-xl font-bold mb-1">Work.ink Method</h3>
                            <p class="text-sm text-zinc-500">Using Work.ink verification</p>
                        </div>
                        <div class="inline-flex items-center gap-2 px-3 py-1.5 bg-blue-500/10 border border-blue-500/20 rounded-lg">
                            <div class="h-2 w-2 rounded-full bg-blue-500"></div>
                            <span class="text-sm font-medium text-blue-400" id="workink-progress-text">0/2 Complete</span>
                        </div>
                    </div>

                    <!-- Enhanced Progress Bar -->
                    <div class="progress-bar-container mb-4">
                        <div id="workink-progress-bar" class="progress-bar-fill-blue" style="width: 0%"></div>
                    </div>

                    <!-- Action Button -->
                    <div id="workink-action">
                        <a href="/Workink" class="inline-flex items-center gap-2 h-10 px-4 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-semibold text-sm btn-primary">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                            View Checkpoint
                        </a>
                    </div>
                    
                    <!-- Key Display (shown when complete) -->
                    <div id="workink-key-display" class="hidden">
                        <div class="bg-white/[0.02] border border-blue-500/20 rounded-lg p-4 mb-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs text-zinc-400 uppercase tracking-wider">Your Access Key</span>
                                <span class="text-xs text-blue-400 font-semibold">✓ Active</span>
                            </div>
                            <div class="font-mono text-lg font-bold text-blue-400 mb-2" id="workink-dashboard-key">XXX-XXX-XXX</div>
                            <div class="flex items-center gap-2 text-xs text-zinc-500">
                                <svg class="w-3 h-3 text-blue-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span>Expires in <span class="font-mono font-semibold text-zinc-300" id="workink-dashboard-countdown">00:00:00</span></span>
                            </div>
                        </div>
                        <a href="/Workink" class="inline-flex items-center gap-2 h-10 px-4 bg-white/5 hover:bg-white/10 border border-white/10 text-white rounded-lg font-semibold text-sm btn-primary">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                            View Key Details
                        </a>
                    </div>
                </div>

                <!-- Lockr Method Card -->
                <div class="border border-white/[0.08] rounded-xl p-6 bg-white/[0.02] card-hover">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="text-xl font-bold mb-1">Lockr Method</h3>
                            <p class="text-sm text-zinc-500">Using Lockr.cc verification</p>
                        </div>
                        <div class="inline-flex items-center gap-2 px-3 py-1.5 bg-purple-500/10 border border-purple-500/20 rounded-lg">
                            <div class="h-2 w-2 rounded-full bg-purple-500"></div>
                            <span class="text-sm font-medium text-purple-400" id="lockr-progress-text">0/2 Complete</span>
                        </div>
                    </div>

                    <!-- Enhanced Progress Bar -->
                    <div class="progress-bar-container mb-4">
                        <div id="lockr-progress-bar" class="progress-bar-fill-purple" style="width: 0%"></div>
                    </div>

                    <!-- Action Button -->
                    <div id="lockr-action">
                        <a href="/Lockr" class="inline-flex items-center gap-2 h-10 px-4 bg-purple-600 hover:bg-purple-500 text-white rounded-lg font-semibold text-sm btn-primary">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                            View Checkpoint
                        </a>
                    </div>
                    
                    <!-- Key Display (shown when complete) -->
                    <div id="lockr-key-display" class="hidden">
                        <div class="bg-white/[0.02] border border-purple-500/20 rounded-lg p-4 mb-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs text-zinc-400 uppercase tracking-wider">Your Access Key</span>
                                <span class="text-xs text-purple-400 font-semibold">✓ Active</span>
                            </div>
                            <div class="font-mono text-lg font-bold text-purple-400 mb-2" id="lockr-dashboard-key">XXX-XXX-XXX</div>
                            <div class="flex items-center gap-2 text-xs text-zinc-500">
                                <svg class="w-3 h-3 text-purple-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span>Expires in <span class="font-mono font-semibold text-zinc-300" id="lockr-dashboard-countdown">00:00:00</span></span>
                            </div>
                        </div>
                        <a href="/Lockr" class="inline-flex items-center gap-2 h-10 px-4 bg-white/5 hover:bg-white/10 border border-white/10 text-white rounded-lg font-semibold text-sm btn-primary">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                            View Key Details
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Links -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <a href="/scripts" class="border border-white/[0.08] rounded-xl p-4 bg-white/[0.02] hover:bg-white/[0.04] transition-all flex items-center gap-3 group">
                <div class="w-10 h-10 rounded-lg bg-blue-500/10 flex items-center justify-center group-hover:bg-blue-500/20 transition-colors">
                    <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                    </svg>
                </div>
                <div>
                    <p class="font-semibold text-sm">Browse Scripts</p>
                    <p class="text-xs text-zinc-500">View available scripts</p>
                </div>
            </a>

            <a href="/faq" class="border border-white/[0.08] rounded-xl p-4 bg-white/[0.02] hover:bg-white/[0.04] transition-all flex items-center gap-3 group">
                <div class="w-10 h-10 rounded-lg bg-purple-500/10 flex items-center justify-center group-hover:bg-purple-500/20 transition-colors">
                    <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div>
                    <p class="font-semibold text-sm">FAQ</p>
                    <p class="text-xs text-zinc-500">Frequently asked questions</p>
                </div>
            </a>

            <a href="/changelog" class="border border-white/[0.08] rounded-xl p-4 bg-white/[0.02] hover:bg-white/[0.04] transition-all flex items-center gap-3 group">
                <div class="w-10 h-10 rounded-lg bg-green-500/10 flex items-center justify-center group-hover:bg-green-500/20 transition-colors">
                    <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                </div>
                <div>
                    <p class="font-semibold text-sm">Changelog</p>
                    <p class="text-xs text-zinc-500">Recent updates</p>
                </div>
            </a>
        </div>
    </div>

    <script>
        const username = 'Tom';

        function initializeCheckpoints() {
            // Work.ink checkpoint
            const workinkCheckpoint = {
                id: 'cp_workink_001',
                name: 'Work.ink Method',
                user: username,
                created: Date.now(),
                steps: [
                    {
                        num: 1,
                        title: 'First Step',
                        prov: 'Work.ink',
                        url: 'https://work.ink/2dbK/GetKey'
                    },
                    {
                        num: 2,
                        title: 'Last Step',
                        prov: 'Work.ink',
                        url: 'https://work.ink/2dbK/Last%20Step'
                    }
                ]
            };

            // Lockr checkpoint
            const lockrCheckpoint = {
                id: 'cp_lockr_001',
                name: 'Lockr Method',
                user: username,
                created: Date.now(),
                steps: [
                    {
                        num: 1,
                        title: 'First Checkpoint',
                        prov: 'Lockr.cc',
                        url: 'https://lockr.cc/YOUR-LINK-1'
                    },
                    {
                        num: 2,
                        title: 'Second Checkpoint',
                        prov: 'Lockr.cc',
                        url: 'https://lockr.cc/YOUR-LINK-2'
                    }
                ]
            };

            // Save to localStorage
            localStorage.setItem(`kg_checkpoint_${username}_${workinkCheckpoint.id}`, JSON.stringify(workinkCheckpoint));
            localStorage.setItem(`kg_checkpoint_${username}_${lockrCheckpoint.id}`, JSON.stringify(lockrCheckpoint));

            // Initialize user data if not exists
            const userDataKey = `kg_data_${username}`;
            if (!localStorage.getItem(userDataKey)) {
                localStorage.setItem(userDataKey, JSON.stringify({
                    username: username,
                    sessionTokens: {}
                }));
            }

            updateProgress();
        }

        function updateDashboardCountdown(expiryTime, countdownId) {
            const now = Date.now();
            const remaining = expiryTime - now;

            if (remaining <= 0) {
                document.getElementById(countdownId).textContent = '00:00:00';
                return;
            }

            const hours = Math.floor(remaining / 3600000);
            const minutes = Math.floor((remaining % 3600000) / 60000);
            const seconds = Math.floor((remaining % 60000) / 1000);
            
            document.getElementById(countdownId).textContent = 
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function updateProgress() {
            const userData = JSON.parse(localStorage.getItem('kg_data_Tom') || '{}');
            const sessionTokens = userData.sessionTokens || {};
            const deviceId = localStorage.getItem('device_id') || 'default';
            const now = Date.now();

            // Check and reset Work.ink progress if key expired
            const workinkKeyData = JSON.parse(localStorage.getItem(`kg_key_workink_${deviceId}`) || 'null');
            if (workinkKeyData && workinkKeyData.expiryTime <= now) {
                // Key expired - reset progress
                const step1KeyWorkink = `cp_workink_001-1-${deviceId}`;
                const step2KeyWorkink = `cp_workink_001-2-${deviceId}`;
                delete sessionTokens[step1KeyWorkink];
                delete sessionTokens[step2KeyWorkink];
                localStorage.setItem('kg_data_Tom', JSON.stringify({...userData, sessionTokens}));
                localStorage.removeItem(`kg_key_workink_${deviceId}`);
            }

            // Check and reset Lockr progress if key expired
            const lockrKeyData = JSON.parse(localStorage.getItem(`kg_key_lockr_${deviceId}`) || 'null');
            if (lockrKeyData && lockrKeyData.expiryTime <= now) {
                // Key expired - reset progress
                const step1KeyLockr = `cp_lockr_001-1-${deviceId}`;
                const step2KeyLockr = `cp_lockr_001-2-${deviceId}`;
                delete sessionTokens[step1KeyLockr];
                delete sessionTokens[step2KeyLockr];
                localStorage.setItem('kg_data_Tom', JSON.stringify({...userData, sessionTokens}));
                localStorage.removeItem(`kg_key_lockr_${deviceId}`);
            }

            // Update Work.ink progress
            let workinkCompletedSteps = 0;
            const step1KeyWorkink = `cp_workink_001-1-${deviceId}`;
            const step2KeyWorkink = `cp_workink_001-2-${deviceId}`;
            
            if (sessionTokens[step1KeyWorkink] && sessionTokens[step1KeyWorkink].verified) {
                workinkCompletedSteps++;
            }
            if (sessionTokens[step2KeyWorkink] && sessionTokens[step2KeyWorkink].verified) {
                workinkCompletedSteps++;
            }

            const workinkProgress = (workinkCompletedSteps / 2) * 100;
            document.getElementById('workink-progress-text').textContent = `${workinkCompletedSteps}/2 Complete`;
            document.getElementById('workink-progress-bar').style.width = `${workinkProgress}%`;

            // Update Lockr progress
            let lockrCompletedSteps = 0;
            const step1KeyLockr = `cp_lockr_001-1-${deviceId}`;
            const step2KeyLockr = `cp_lockr_001-2-${deviceId}`;
            
            if (sessionTokens[step1KeyLockr] && sessionTokens[step1KeyLockr].verified) {
                lockrCompletedSteps++;
            }
            if (sessionTokens[step2KeyLockr] && sessionTokens[step2KeyLockr].verified) {
                lockrCompletedSteps++;
            }

            const lockrProgress = (lockrCompletedSteps / 2) * 100;
            document.getElementById('lockr-progress-text').textContent = `${lockrCompletedSteps}/2 Complete`;
            document.getElementById('lockr-progress-bar').style.width = `${lockrProgress}%`;

            // Check Work.ink key
            if (workinkCompletedSteps === 2) {
                const keyData = JSON.parse(localStorage.getItem(`kg_key_workink_${deviceId}`) || 'null');
                
                if (keyData && keyData.expiryTime > now) {
                    document.getElementById('workink-action').classList.add('hidden');
                    document.getElementById('workink-key-display').classList.remove('hidden');
                    document.getElementById('workink-dashboard-key').textContent = keyData.key;
                    updateDashboardCountdown(keyData.expiryTime, 'workink-dashboard-countdown');
                } else {
                    document.getElementById('workink-action').classList.remove('hidden');
                    document.getElementById('workink-key-display').classList.add('hidden');
                }
            } else {
                document.getElementById('workink-action').classList.remove('hidden');
                document.getElementById('workink-key-display').classList.add('hidden');
            }

            // Check Lockr key
            if (lockrCompletedSteps === 2) {
                const keyData = JSON.parse(localStorage.getItem(`kg_key_lockr_${deviceId}`) || 'null');
                
                if (keyData && keyData.expiryTime > now) {
                    document.getElementById('lockr-action').classList.add('hidden');
                    document.getElementById('lockr-key-display').classList.remove('hidden');
                    document.getElementById('lockr-dashboard-key').textContent = keyData.key;
                    updateDashboardCountdown(keyData.expiryTime, 'lockr-dashboard-countdown');
                } else {
                    document.getElementById('lockr-action').classList.remove('hidden');
                    document.getElementById('lockr-key-display').classList.add('hidden');
                }
            } else {
                document.getElementById('lockr-action').classList.remove('hidden');
                document.getElementById('lockr-key-display').classList.add('hidden');
            }
        }

        // Initialize on load
        initializeCheckpoints();

        // Refresh progress every 2 seconds
        setInterval(updateProgress, 2000);

        // Redeem Key button handler
        document.addEventListener('DOMContentLoaded', function() {
            const redeemBtn = document.getElementById('redeem-key-btn');
            if (redeemBtn) {
                redeemBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (window.RedeemSystem && window.RedeemSystem.openRedeemModal) {
                        window.RedeemSystem.openRedeemModal();
                    }
                });
            }
        });
    </script>

    <!-- Enhanced Features -->
    <script src="/enhanced-features.js"></script>

</body>
</html>
